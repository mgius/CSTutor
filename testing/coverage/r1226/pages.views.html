<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>code coverage of views.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<style type="text/css">
pre.code {
    font-style: Lucida,"Courier New";
}
.number {
    color: #0080C0;
}
.operator {
    color: #000000;
}
.string {
    color: #008000;
}
.comment {
    color: #808080;
}
.name {
    color: #000000;
}
.error {
    color: #FF8080;
    border: solid 1.5pt #FF0000;
}
.keyword {
    color: #0000FF;
    font-weight: bold;
}
.text {
    color: #000000;
}
.notcovered {
    background-color: #FFB2B2;
}
</style>

</head>
<body>
<pre class="code">
<span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">shortcuts</span> <span class="keyword">import</span> <span class="name">render_to_response</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">http</span> <span class="keyword">import</span> <span class="name">HttpResponse</span><span class="operator">,</span> <span class="name">HttpResponseRedirect</span><span class="operator">,</span> <span class="name">Http404</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">contrib</span><span class="operator">.</span><span class="name">auth</span><span class="operator">.</span><span class="name">decorators</span> <span class="keyword">import</span> <span class="name">login_required</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">core</span><span class="operator">.</span><span class="name">urlresolvers</span> <span class="keyword">import</span> <span class="name">reverse</span><span class="text">
</span><span class="comment">#from page.models import Page
</span><span class="keyword">from</span> <span class="name">models</span> <span class="keyword">import</span> <span class="name">Page</span><span class="text">
</span><span class="comment">#from page.lesson.views import show_lesson
</span><span class="keyword">from</span> <span class="name">lesson</span><span class="operator">.</span><span class="name">views</span> <span class="keyword">import</span> <span class="name">show_lesson</span><span class="text">
</span><span class="keyword">from</span> <span class="name">quiz</span><span class="operator">.</span><span class="name">views</span> <span class="keyword">import</span> <span class="name">show_quiz</span><span class="text">
</span><span class="keyword">from</span> <span class="name">lesson</span><span class="operator">.</span><span class="name">views</span> <span class="keyword">import</span> <span class="name">edit_lesson</span><span class="text">
</span><span class="keyword">from</span> <span class="name">quiz</span><span class="operator">.</span><span class="name">views</span> <span class="keyword">import</span> <span class="name">edit_quiz</span><span class="text">
</span><span class="keyword">from</span> <span class="name">quiz</span><span class="operator">.</span><span class="name">models</span> <span class="keyword">import</span> <span class="name">Quiz</span><span class="text">
</span><span class="keyword">from</span> <span class="name">lesson</span><span class="operator">.</span><span class="name">models</span> <span class="keyword">import</span> <span class="name">Lesson</span><span class="text">
</span><span class="keyword">from</span> <span class="name">models</span> <span class="keyword">import</span> <span class="name">Course</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">core</span><span class="operator">.</span><span class="name">exceptions</span> <span class="keyword">import</span> <span class="name">ObjectDoesNotExist</span><span class="text">
</span><span class="keyword">from</span> <span class="name">home</span><span class="operator">.</span><span class="name">views</span> <span class="keyword">import</span> <span class="name">master_rtr</span><span class="operator">,</span> <span class="name">custom_403</span><span class="operator">,</span> <span class="name">custom_404</span><span class="text">
</span><span class="keyword">from</span> <span class="name">pages</span><span class="operator">.</span><span class="name">page</span> <span class="keyword">import</span> <span class="name">movePage</span><span class="operator">,</span> <span class="name">movePageToParent</span><span class="text">
</span><span class="text">
</span><span class="string">'''
Views file for page related view

Contains the show_page function

@author Evan Kleist
@author Russell Mezzetta
@author James Pearson
'''</span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">show_page</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        This "view" does error checking to verify that the input course/page exist
        Then it checks that the user has view permissions if they are required
        Finally it invokes the lesson or quiz view depending on the type of page
        '''</span><span class="text">
</span>        <span class="comment">#check if the course is a real course in the database   
</span>        <span class="keyword">try</span><span class="operator">:</span> <span class="text">
</span>                <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span>        <span class="keyword">except</span> <span class="name">Course</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                <span class="comment">#return HttpResponse("ERROR: BAD URL: The course: %s does not exist" % (course_slug))
</span>                <span class="keyword">raise</span> <span class="name">Http404</span><span class="text">
</span>        <span class="text">
</span>        <span class="comment">#check if the page is a real page in the database
</span>        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                <span class="name">page</span> <span class="operator">=</span> <span class="name">Page</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">page_slug</span><span class="operator">)</span><span class="text">
</span>        <span class="keyword">except</span> <span class="name">Page</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                <span class="comment">#return HttpResponse("ERROR: BAD URL: The course: %s does not contain the page: %s." % (course_slug, page_slug))
</span>                <span class="keyword">raise</span> <span class="name">Http404</span><span class="text">
</span>        <span class="text">
</span>        <span class="comment">#if the course is private then check that the user is enrolled and has view permissions
</span>        <span class="keyword">if</span> <span class="name">course</span><span class="operator">.</span><span class="name">private</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>                        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'page/denied.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span><span class="name">course</span><span class="operator">,</span> <span class="string">'enrolled'</span><span class="operator">:</span><span class="name">False</span><span class="operator">,</span> <span class="string">'edit'</span><span class="operator">:</span><span class="name">False</span><span class="operator">,</span> <span class="string">'loggedIn'</span><span class="operator">:</span><span class="name">False</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span>                <span class="keyword">try</span><span class="operator">:</span><span class="comment">#try to get the enrollment for this user and check view permission</span><span class="text">
</span>                        <span class="name">e</span> <span class="operator">=</span> <span class="name">page</span><span class="operator">.</span><span class="name">course</span><span class="operator">.</span><span class="name">roster</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">user</span><span class="operator">=</span><span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">)</span><span class="text">
</span>                        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">e</span><span class="operator">.</span><span class="name">view</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'page/denied.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span><span class="name">course</span><span class="operator">,</span> <span class="string">'enrolled'</span><span class="operator">:</span><span class="name">True</span><span class="operator">,</span> <span class="string">'edit'</span><span class="operator">:</span><span class="name">False</span><span class="operator">,</span> <span class="string">'loggedIn'</span><span class="operator">:</span><span class="name">True</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span>                <span class="keyword">except</span> <span class="name">ObjectDoesNotExist</span><span class="operator">:</span><span class="text">
</span>                        <span class="comment"># user is not enrolled in this course
</span>                        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'page/denied.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span><span class="name">course</span><span class="operator">,</span> <span class="string">'enrolled'</span><span class="operator">:</span><span class="name">False</span><span class="operator">,</span> <span class="string">'edit'</span><span class="operator">:</span><span class="name">False</span><span class="operator">,</span> <span class="string">'loggedIn'</span><span class="operator">:</span><span class="name">True</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="text">
</span>        <span class="comment">#cast the page to a lesson or quiz then call show on it
</span>        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                <span class="name">page</span> <span class="operator">=</span> <span class="name">page</span><span class="operator">.</span><span class="name">lesson</span><span class="text">
</span>                <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>                        <span class="comment">#save this data to session
</span><span class="notcovered">                        <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastCourseSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">course_slug</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">page_slug</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageEdit'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">False</span></span><span class="text">
</span>                <span class="keyword">return</span> <span class="name">show_lesson</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">,</span> <span class="name">page</span><span class="operator">)</span><span class="text">
</span>        <span class="keyword">except</span> <span class="name">Lesson</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">page</span> <span class="operator">=</span> <span class="name">page</span><span class="operator">.</span><span class="name">quiz</span><span class="text">
</span>                        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>                                <span class="comment">#save this data to session
</span>                                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastCourseSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">course_slug</span><span class="text">
</span>                                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">page_slug</span><span class="text">
</span>                                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageEdit'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">False</span><span class="text">
</span>                        <span class="keyword">return</span> <span class="name">show_quiz</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">)</span><span class="text">
</span><span class="notcovered">                <span class="keyword">except</span> <span class="name">Quiz</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">raise</span> <span class="name">Http404</span></span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">edit_page</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        This view verifies that a valid course/page pair is given, then verifies that the user has edit permissions,
        finally it calls the quiz/lesson edit view depending on what kind of page is given.
        '''</span><span class="text">
</span>        <span class="comment">#check if the course is a real course in the database   
</span>        <span class="keyword">try</span><span class="operator">:</span> <span class="text">
</span>                <span class="name">c</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span>        <span class="keyword">except</span> <span class="name">Course</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">raise</span> <span class="name">Http404</span><span class="text">
</span>        <span class="comment">#check if the page is a real page in the database
</span>        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                <span class="name">page</span> <span class="operator">=</span> <span class="name">c</span><span class="operator">.</span><span class="name">pages</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">page_slug</span><span class="operator">)</span><span class="text">
</span>        <span class="keyword">except</span> <span class="name">Page</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">raise</span> <span class="name">Http404</span><span class="text">
</span><span class="text">
</span>        <span class="comment">#check that user has permissions (edit)
</span>        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'page/denied.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span><span class="name">course_slug</span><span class="operator">,</span> <span class="string">'enrolled'</span><span class="operator">:</span><span class="name">False</span><span class="operator">,</span> <span class="string">'edit'</span><span class="operator">:</span><span class="name">True</span><span class="operator">,</span> <span class="string">'loggedIn'</span><span class="operator">:</span><span class="name">False</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span><span class="notcovered">        <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="comment">#get user's enrollment to check permissions
</span>                <span class="name">e</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">course</span> <span class="operator">=</span> <span class="name">c</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">except</span> <span class="name">ObjectDoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'page/denied.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span><span class="name">course_slug</span><span class="operator">,</span> <span class="string">'enrolled'</span><span class="operator">:</span><span class="name">False</span><span class="operator">,</span> <span class="string">'edit'</span><span class="operator">:</span><span class="name">True</span><span class="operator">,</span> <span class="string">'loggedIn'</span><span class="operator">:</span><span class="name">True</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">e</span><span class="operator">.</span><span class="name">edit</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'page/denied.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span><span class="name">course_slug</span><span class="operator">,</span> <span class="string">'enrolled'</span><span class="operator">:</span><span class="name">True</span><span class="operator">,</span> <span class="string">'edit'</span><span class="operator">:</span><span class="name">True</span><span class="operator">,</span> <span class="string">'loggedIn'</span><span class="operator">:</span><span class="name">True</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="comment">#cast the page to a lesson or quiz then call show on it
</span>        <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="name">page</span> <span class="operator">=</span> <span class="name">page</span><span class="operator">.</span><span class="name">lesson</span></span><span class="text">
</span><span class="notcovered">                <span class="comment">#save this data to session
</span>                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastCourseSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">course_slug</span></span><span class="text">
</span><span class="notcovered">                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">page_slug</span></span><span class="text">
</span><span class="notcovered">                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageEdit'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">True</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">edit_lesson</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">except</span> <span class="name">Lesson</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">page</span> <span class="operator">=</span> <span class="name">page</span><span class="operator">.</span><span class="name">quiz</span></span><span class="text">
</span><span class="notcovered">                        <span class="comment">#save this data to session
</span>                        <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastCourseSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">course_slug</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageSlug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">page_slug</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageEdit'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">True</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">return</span> <span class="name">edit_quiz</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">except</span> <span class="name">Quiz</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">return</span> <span class="name">Http404</span></span><span class="text">
</span><span class="text">
</span><span class="operator">@</span><span class="name">login_required</span><span class="text">
</span><span class="keyword">def</span> <span class="name">move_page</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        @author Russell Mezzetta
        This view allows instructors to move pages around       in a course.
        '''</span><span class="text">
</span>        <span class="comment">#check to make sure that we are not trying to move a course-page
</span><span class="notcovered">        <span class="keyword">if</span> <span class="name">course_slug</span> <span class="operator">==</span> <span class="name">page_slug</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">custom_404</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">"You may not move a course's home page"</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">        <span class="comment">#check if the course is a real course in the database 
</span>        <span class="name">data</span> <span class="operator">=</span> <span class="operator">{</span><span class="operator">}</span></span><span class="text">
</span><span class="notcovered">        <span class="name">data</span><span class="operator">[</span><span class="string">'course_slug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">course_slug</span></span><span class="text">
</span><span class="notcovered">        <span class="name">data</span><span class="operator">[</span><span class="string">'page_slug'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">page_slug</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="name">data</span><span class="operator">[</span><span class="string">'course'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">except</span> <span class="name">Course</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">custom_404</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">"BAD URL: The course: %s does not exist"</span> <span class="operator">%</span> <span class="operator">(</span><span class="name">course_slug</span><span class="operator">)</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span>        <span class="text">
</span><span class="notcovered">        <span class="comment">#check that user has edit permissions on the course
</span>        <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="name">e</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">course</span> <span class="operator">=</span> <span class="name">data</span><span class="operator">[</span><span class="string">'course'</span><span class="operator">]</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">e</span><span class="operator">.</span><span class="name">edit</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="comment">#return ("ERROR: User does not have edit permissions on the course")
</span>                        <span class="keyword">return</span> <span class="name">custom_403</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">"User does not have edit permissions on the course"</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">except</span> <span class="name">ObjectDoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">custom_403</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">"User is not enrolled in the course"</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span>        <span class="text">
</span><span class="notcovered">        <span class="comment">#check if the page is a real page in the database
</span>        <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="name">data</span><span class="operator">[</span><span class="string">'page'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">Page</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">page_slug</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">except</span> <span class="name">Page</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">custom_404</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">"ERROR: BAD URL: The course: %s does not contain the page: %s."</span> <span class="operator">%</span> <span class="operator">(</span><span class="name">course_slug</span><span class="operator">,</span> <span class="name">page_slug</span><span class="operator">)</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="comment">#TODO CHECK USER FOR EDIT PERMISSIONS, redirect to error page if invalid user
</span></span><span class="text">
</span><span class="notcovered">        <span class="comment">#save a list of all pages in the course EXCEPT the given page
</span>        <span class="name">data</span><span class="operator">[</span><span class="string">'pagelist'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">data</span><span class="operator">[</span><span class="string">'course'</span><span class="operator">]</span><span class="operator">.</span><span class="name">pages</span><span class="operator">.</span><span class="name">all</span><span class="operator">(</span><span class="operator">)</span><span class="operator">.</span><span class="name">exclude</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">page_slug</span><span class="operator">)</span><span class="operator">.</span><span class="name">order_by</span><span class="operator">(</span><span class="string">'left'</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">method</span> <span class="operator">==</span> <span class="string">"POST"</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">if</span> <span class="string">"referencePageID"</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span> <span class="keyword">and</span> <span class="string">"siblingOrChild"</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="comment">#get the page specified by refPageID from the data['pagelist']
</span>                        <span class="name">refPage</span> <span class="operator">=</span> <span class="name">None</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">for</span> <span class="name">p</span> <span class="keyword">in</span> <span class="name">data</span><span class="operator">[</span><span class="string">'pagelist'</span><span class="operator">]</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">if</span> <span class="name">p</span><span class="operator">.</span><span class="name">slug</span> <span class="operator">==</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'referencePageID'</span><span class="operator">]</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                        <span class="name">refPage</span> <span class="operator">=</span> <span class="name">p</span></span><span class="text">
</span><span class="notcovered">                                        <span class="keyword">break</span></span><span class="text">
</span><span class="notcovered">                        <span class="comment">#verify that the refPage was found
</span>                        <span class="keyword">if</span> <span class="name">refPage</span> <span class="operator">==</span> <span class="name">None</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">return</span> <span class="name">HttpResponse</span><span class="operator">(</span><span class="string">"error, the previously selected page somehow is no longer in the list of pages in this course"</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span>                        <span class="text">
</span><span class="notcovered">                        <span class="comment">#movePage should be passed lessons or quizzes, 
</span>                        <span class="comment">#cast refPage and data['page'] appropriately
</span>                        <span class="name">p1</span> <span class="operator">=</span> <span class="name">data</span><span class="operator">[</span><span class="string">'page'</span><span class="operator">]</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">try</span><span class="operator">:</span> <span class="comment">#to cast to a lesson</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">p1</span> <span class="operator">=</span> <span class="name">p1</span><span class="operator">.</span><span class="name">lesson</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">except</span> <span class="name">Lesson</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">try</span><span class="operator">:</span> <span class="comment">#to cast to a quiz </span></span><span class="text">
</span><span class="notcovered">                                        <span class="name">p1</span> <span class="operator">=</span> <span class="name">p1</span><span class="operator">.</span><span class="name">quiz</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">except</span> <span class="name">Quiz</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                        <span class="keyword">print</span> <span class="string">"warning -- move_page view, page neither quiz nor lesson"</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">                        <span class="name">p2</span> <span class="operator">=</span> <span class="name">refPage</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">try</span><span class="operator">:</span> <span class="comment">#to cast to a lesson</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">p2</span> <span class="operator">=</span> <span class="name">p2</span><span class="operator">.</span><span class="name">lesson</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">except</span> <span class="name">Lesson</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">try</span><span class="operator">:</span> <span class="comment">#to cast to a quiz </span></span><span class="text">
</span><span class="notcovered">                                        <span class="name">p2</span> <span class="operator">=</span> <span class="name">p2</span><span class="operator">.</span><span class="name">quiz</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">except</span> <span class="name">Quiz</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                        <span class="keyword">print</span> <span class="string">"warning -- move_page view, page neither quiz nor lesson"</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'siblingOrChild'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">"sibling"</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="comment">#from pdb import set_trace; set_trace()
</span>                                <span class="comment">#move page to be the first sibling of refPage
</span>                                <span class="name">movePage</span><span class="operator">(</span><span class="name">p1</span><span class="operator">,</span> <span class="name">p2</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">else</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="comment">#move the page to be the first child of refPage
</span>                                <span class="name">movePageToParent</span><span class="operator">(</span><span class="name">p1</span><span class="operator">,</span> <span class="name">p2</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">                        <span class="name">data</span><span class="operator">[</span><span class="string">'redirectUrl'</span><span class="operator">]</span> <span class="operator">=</span> <span class="string">"/"</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">data</span><span class="operator">[</span><span class="string">'redirectText'</span><span class="operator">]</span> <span class="operator">=</span> <span class="string">"the home page"</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">return</span> <span class="name">HttpResponseRedirect</span><span class="operator">(</span><span class="name">reverse</span><span class="operator">(</span><span class="string">'pages.views.edit_page'</span><span class="operator">,</span> <span class="name">args</span><span class="operator">=</span><span class="operator">[</span><span class="name">p1</span><span class="operator">.</span><span class="name">course</span><span class="operator">.</span><span class="name">slug</span><span class="operator">,</span> <span class="name">p1</span><span class="operator">.</span><span class="name">slug</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                        <span class="comment">#return master_rtr(request, 'redirect.html', data)
</span>                        <span class="comment">#return master_rtr(request, 'page/move_page_success.html')
</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'page/move_page.html'</span><span class="operator">,</span> <span class="name">data</span><span class="operator">)</span><span class="text"></span></span>
</pre></body>
</html>
