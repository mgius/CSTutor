<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>code coverage of views.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<style type="text/css">
pre.code {
    font-style: Lucida,"Courier New";
}
.number {
    color: #0080C0;
}
.operator {
    color: #000000;
}
.string {
    color: #008000;
}
.comment {
    color: #808080;
}
.name {
    color: #000000;
}
.error {
    color: #FF8080;
    border: solid 1.5pt #FF0000;
}
.keyword {
    color: #0000FF;
    font-weight: bold;
}
.text {
    color: #000000;
}
.notcovered {
    background-color: #FFB2B2;
}
</style>

</head>
<body>
<pre class="code">
<span class="string">''' 
Contains the views for the home package. 

@author James Pearson
@author Matt Tytel
@author John Hartquist
@author Jon Inloes 
'''</span><span class="text">
</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">conf</span> <span class="keyword">import</span> <span class="name">settings</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">shortcuts</span> <span class="keyword">import</span> <span class="name">render_to_response</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">template</span> <span class="keyword">import</span> <span class="name">RequestContext</span><span class="text">
</span><span class="keyword">from</span> <span class="name">courses</span><span class="operator">.</span><span class="name">models</span> <span class="keyword">import</span> <span class="name">Course</span><span class="operator">,</span> <span class="name">Enrollment</span><span class="text">
</span><span class="keyword">from</span> <span class="name">pages</span><span class="operator">.</span><span class="name">lesson</span><span class="operator">.</span><span class="name">models</span> <span class="keyword">import</span> <span class="name">Lesson</span><span class="text">
</span><span class="keyword">from</span> <span class="name">pages</span><span class="operator">.</span><span class="name">quiz</span><span class="operator">.</span><span class="name">models</span> <span class="keyword">import</span> <span class="name">Quiz</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">core</span><span class="operator">.</span><span class="name">exceptions</span> <span class="keyword">import</span> <span class="name">ObjectDoesNotExist</span><span class="text">
</span><span class="keyword">import</span> <span class="name">datetime</span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">template</span><span class="operator">,</span> <span class="name">data</span> <span class="operator">=</span> <span class="operator">{</span><span class="operator">}</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        Return an HttpResponse, generated by rendering `template` with `data`.
        
        The function signature is identical to that of `render_to_response()`.
        We use this everywhere, though, because we need to add some extra
        information to each page, for the navigation, particularly.
        '''</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>                <span class="comment"># Since we're only grabbing the enrollments to get at the courses, 
</span>                <span class="comment"># doing select_related() will save us from having to hit database for
</span>                <span class="comment"># every course the user is enrolled in
</span>                <span class="name">data</span><span class="operator">[</span><span class="string">'courses'</span><span class="operator">]</span> <span class="operator">=</span> \
                        <span class="operator">[</span><span class="name">e</span><span class="operator">.</span><span class="name">course</span> <span class="keyword">for</span> <span class="name">e</span> <span class="keyword">in</span> \
                         <span class="name">Enrollment</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">select_related</span><span class="operator">(</span><span class="operator">)</span><span class="operator">.</span><span class="name">filter</span><span class="operator">(</span><span class="name">user</span><span class="operator">=</span><span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">)</span> \
                         <span class="keyword">if</span> <span class="name">e</span><span class="operator">.</span><span class="name">view</span><span class="operator">]</span><span class="text">
</span>        <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">if</span> <span class="string">"anonCourses"</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">data</span><span class="operator">[</span><span class="string">'courses'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span><span class="text">
</span>                <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">data</span><span class="operator">[</span><span class="string">'courses'</span><span class="operator">]</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span><span class="text">
</span>        <span class="text">
</span>        <span class="name">data</span><span class="operator">[</span><span class="string">'THEME'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">settings</span><span class="operator">.</span><span class="name">THEME</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">return</span> <span class="name">render_to_response</span><span class="operator">(</span><span class="name">template</span><span class="operator">,</span> <span class="name">data</span><span class="operator">,</span> <span class="name">context_instance</span><span class="operator">=</span><span class="name">RequestContext</span><span class="operator">(</span><span class="name">request</span><span class="operator">)</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="comment">#def index(request):
</span><span class="comment">#       return master_rtr(request, 'index.html')
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">show_homepage</span><span class="operator">(</span><span class="name">request</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        @author Russell Mezzetta
        This shows the homepage for anonymous and logged in users
        '''</span><span class="text">
</span>        <span class="name">data</span><span class="operator">=</span><span class="operator">{</span><span class="operator">}</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>                <span class="comment">#get and format the last login date/time
</span>                <span class="name">lastLogin</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">last_login</span><span class="text">
</span>                <span class="name">data</span><span class="operator">[</span><span class="string">'loginDate'</span><span class="operator">]</span> <span class="operator">=</span> <span class="string">"%s/%s/%s"</span> <span class="operator">%</span> <span class="operator">(</span><span class="name">lastLogin</span><span class="operator">.</span><span class="name">month</span><span class="operator">,</span> <span class="name">lastLogin</span><span class="operator">.</span><span class="name">day</span><span class="operator">,</span> <span class="name">lastLogin</span><span class="operator">.</span><span class="name">year</span><span class="operator">)</span><span class="text">
</span>                <span class="name">data</span><span class="operator">[</span><span class="string">'loginTime'</span><span class="operator">]</span> <span class="operator">=</span> <span class="string">"%s:%s:%s"</span> <span class="operator">%</span> <span class="operator">(</span><span class="name">lastLogin</span><span class="operator">.</span><span class="name">hour</span><span class="operator">,</span> <span class="name">lastLogin</span><span class="operator">.</span><span class="name">minute</span><span class="operator">,</span> <span class="name">lastLogin</span><span class="operator">.</span><span class="name">second</span><span class="operator">)</span><span class="text">
</span>                <span class="text">
</span>                <span class="comment">#check for last course / lesson in session
</span>                <span class="keyword">if</span> <span class="string">'lastCourseSlug'</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span> <span class="keyword">and</span> <span class="string">'lastPageSlug'</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span> <span class="keyword">and</span> <span class="string">'lastPageEdit'</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">lastCourseSlug</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastCourseSlug'</span><span class="operator">]</span><span class="text">
</span>                        <span class="name">lastPageSlug</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageSlug'</span><span class="operator">]</span><span class="text">
</span>                        <span class="name">lastPageEdit</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'lastPageEdit'</span><span class="operator">]</span><span class="text">
</span>                        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                <span class="comment">#may not still exist!
</span>                                <span class="name">c</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">lastCourseSlug</span><span class="operator">)</span><span class="text">
</span>                                <span class="name">p</span> <span class="operator">=</span> <span class="name">c</span><span class="operator">.</span><span class="name">pages</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">lastPageSlug</span><span class="operator">)</span><span class="text">
</span>                                <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                        <span class="name">p</span> <span class="operator">=</span> <span class="name">p</span><span class="operator">.</span><span class="name">lesson</span><span class="text">
</span>                                <span class="keyword">except</span> <span class="name">Lesson</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                                        <span class="comment"># lastCourseSlug, etc can ONLY exist if at some point
</span>                                        <span class="comment"># this combination of course/page slug was a 
</span>                                        <span class="comment"># real lesson or quiz.  Therefore, due to this fact,
</span>                                        <span class="comment"># DO NOT check if it's a quiz.  The ONLY way that
</span>                                        <span class="comment"># these variables could be set, and p.lesson and 
</span>                                        <span class="comment"># p.quiz were both invalid is if some asshat with 
</span>                                        <span class="comment"># database access dropped the Lesson/Quiz but
</span>                                        <span class="comment"># not the page.  Therefore due to difficulty in code coveraging
</span>                                        <span class="comment"># this path, we're just gonna assume that the damn thing exists
</span>                                        <span class="comment">#try: 
</span>                                        <span class="name">p</span> <span class="operator">=</span> <span class="name">p</span><span class="operator">.</span><span class="name">quiz</span><span class="text">
</span>                                        <span class="comment">#except Quiz.DoesNotExist:
</span>                                        <span class="comment">#       print "OH NO! page is neither lesson nor quiz"
</span>                                        <span class="comment">#       data['lastPageNoLongerExists'] = True
</span><span class="text">
</span>                                <span class="name">data</span><span class="operator">[</span><span class="string">'lastCourse'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">c</span><span class="text">
</span>                                <span class="name">data</span><span class="operator">[</span><span class="string">'lastPage'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">p</span><span class="text">
</span>                                <span class="name">data</span><span class="operator">[</span><span class="string">'lastPageEdit'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">lastPageEdit</span><span class="text">
</span>                        <span class="keyword">except</span> <span class="name">ObjectDoesNotExist</span><span class="operator">:</span><span class="text">
</span>                                <span class="comment">#course or lesson no longer exists
</span>                                <span class="name">data</span><span class="operator">[</span><span class="string">'lastPageNoLongerExists'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span><span class="text">
</span>                <span class="comment">#get the number of courses the user is enrolled in
</span>                <span class="name">enrolled</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">all</span><span class="operator">(</span><span class="operator">)</span><span class="text">
</span>                <span class="name">pending</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span><span class="text">
</span>                <span class="keyword">for</span> <span class="name">e</span> <span class="keyword">in</span> <span class="name">enrolled</span><span class="operator">:</span><span class="text">
</span>                        <span class="keyword">if</span> <span class="name">e</span><span class="operator">.</span><span class="name">view</span> <span class="operator">==</span> <span class="name">False</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">pending</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">e</span><span class="operator">.</span><span class="name">course</span><span class="operator">)</span><span class="text">
</span>                <span class="keyword">if</span> <span class="name">len</span><span class="operator">(</span><span class="name">pending</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">data</span><span class="operator">[</span><span class="string">'pending'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">pending</span><span class="text">
</span><span class="text">
</span>                <span class="name">data</span><span class="operator">[</span><span class="string">'numClasses'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">count</span><span class="operator">(</span><span class="operator">)</span><span class="text">
</span>                <span class="keyword">if</span> <span class="name">data</span><span class="operator">[</span><span class="string">'numClasses'</span><span class="operator">]</span> <span class="operator">&lt;=</span> <span class="number">0</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">data</span><span class="operator">[</span><span class="string">'not_enrolled'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                <span class="keyword">else</span><span class="operator">:</span><span class="comment">#user enrolled in 1 or more classes</span><span class="text">
</span>                        <span class="name">data</span><span class="operator">[</span><span class="string">'not_enrolled'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">False</span><span class="text">
</span>        <span class="keyword">else</span><span class="operator">:</span> <span class="comment">#User is anonymous</span><span class="text">
</span>                <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">"anonCourses"</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">data</span><span class="operator">[</span><span class="string">'not_enrolled'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span>                        <span class="comment">#added this in case someone clobbers request.session
</span>                        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span> <span class="operator">!=</span> <span class="name">None</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">data</span><span class="operator">[</span><span class="string">'numClasses'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">len</span><span class="operator">(</span><span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span><span class="operator">)</span><span class="text">
</span>        <span class="text">
</span>        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'homepage.html'</span><span class="operator">,</span> <span class="name">data</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">show_help</span><span class="operator">(</span><span class="name">request</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        Displays the help page

        @author Jon Inloes
        '''</span><span class="text">
</span>        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'help/index.html'</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">custom_404</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">message</span><span class="operator">=</span><span class="string">''</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        404 page that uses `master_rtr()`
        
        @author James Pearson
        '''</span><span class="text">
</span>        <span class="name">response</span> <span class="operator">=</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'404.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'message'</span><span class="operator">:</span><span class="name">message</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span>        <span class="name">response</span><span class="operator">.</span><span class="name">status_code</span> <span class="operator">=</span> <span class="number">404</span><span class="text">
</span>        <span class="keyword">return</span> <span class="name">response</span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">custom_500</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">message</span><span class="operator">=</span><span class="string">''</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        500 page that uses `master_rtr()`
        
        @author James Pearson
        '''</span><span class="text">
</span><span class="notcovered">        <span class="name">response</span> <span class="operator">=</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'500.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'message'</span><span class="operator">:</span><span class="name">message</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="name">response</span><span class="operator">.</span><span class="name">status_code</span> <span class="operator">=</span> <span class="number">500</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">return</span> <span class="name">response</span></span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">custom_403</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">message</span><span class="operator">=</span><span class="string">''</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        403 page that uses `master_rtr()`
        
        @author Russell Mezzetta
        '''</span><span class="text">
</span>        <span class="name">response</span> <span class="operator">=</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'403.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'message'</span><span class="operator">:</span><span class="name">message</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span>        <span class="name">response</span><span class="operator">.</span><span class="name">status_code</span> <span class="operator">=</span> <span class="number">403</span><span class="text">
</span>        <span class="keyword">return</span> <span class="name">response</span><span class="text"></span>
</pre></body>
</html>
