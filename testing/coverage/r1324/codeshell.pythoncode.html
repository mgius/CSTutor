<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>code coverage of pythoncode.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<style type="text/css">
pre.code {
    font-style: Lucida,"Courier New";
}
.number {
    color: #0080C0;
}
.operator {
    color: #000000;
}
.string {
    color: #008000;
}
.comment {
    color: #808080;
}
.name {
    color: #000000;
}
.error {
    color: #FF8080;
    border: solid 1.5pt #FF0000;
}
.keyword {
    color: #0000FF;
    font-weight: bold;
}
.text {
    color: #000000;
}
.notcovered {
    background-color: #FFB2B2;
}
</style>

</head>
<body>
<pre class="code">
<span class="string">'''
Functions that are useful for executing python.

This could be as simple as an "eval," but it is sometimes handy to do something
like sanitize code or capture output, etc, so we have a special execute
function that will abstract all that garbage out

Currently no checks on long-running code.

@author Mark Gius
@author James Pearson
'''</span><span class="text">
</span><span class="text">
</span><span class="text">
</span><span class="notcovered"><span class="keyword">from</span> <span class="name">RestrictedPython</span> <span class="keyword">import</span> <span class="name">compile_restricted</span></span><span class="text">
</span><span class="notcovered"><span class="keyword">from</span> <span class="name">RestrictedPython</span><span class="operator">.</span><span class="name">PrintCollector</span> <span class="keyword">import</span> <span class="name">PrintCollector</span></span><span class="text">
</span><span class="notcovered"><span class="keyword">from</span> <span class="name">RestrictedPython</span><span class="operator">.</span><span class="name">Guards</span> <span class="keyword">import</span> <span class="name">safe_builtins</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered"><span class="keyword">def</span> <span class="name">evalPythonString</span><span class="operator">(</span><span class="name">string</span><span class="operator">)</span><span class="operator">:</span></span><span class="text">
</span>        <span class="string">'''
        Executes strings of python code

        Takes in a string and evaluates it. 

        Returns a tuple of the print output and a dictionary of the variables as
        they existed at the end of the code execution
        '''</span><span class="text">
</span>        <span class="name">string</span> <span class="operator">+=</span> <span class="string">"\ncodeShellOutput_ = printed\n"</span><span class="text">
</span><span class="text">
</span>        <span class="name">code</span> <span class="operator">=</span> <span class="name">compile_restricted</span><span class="operator">(</span><span class="name">string</span><span class="operator">,</span> <span class="string">'&lt;string&gt;'</span><span class="operator">,</span> <span class="string">'exec'</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>        <span class="name">restrictedScope</span> <span class="operator">=</span> <span class="operator">{</span><span class="string">'_print_'</span><span class="operator">:</span><span class="name">PrintCollector</span><span class="operator">,</span> <span class="string">'__builtins__'</span><span class="operator">:</span><span class="name">safe_builtins</span><span class="operator">,</span> \
                                <span class="string">'codeShellOutput_'</span><span class="operator">:</span><span class="string">''</span><span class="operator">}</span><span class="text">
</span>        <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'_getiter_'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">iter</span><span class="text">
</span>        <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'__name__'</span><span class="operator">]</span> <span class="operator">=</span> <span class="string">'&lt;string&gt;'</span><span class="text">
</span>        <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'_getattr_'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">getattr</span><span class="text">
</span>        <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'_write_'</span><span class="operator">]</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">obj</span><span class="operator">:</span> <span class="name">obj</span><span class="text">
</span>        <span class="name">codeOutput</span> <span class="operator">=</span> <span class="string">""</span><span class="text">
</span>        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">exec</span><span class="operator">(</span><span class="name">code</span><span class="operator">,</span> <span class="name">restrictedScope</span><span class="operator">)</span><span class="text">
</span>        <span class="text">
</span>                <span class="name">codeOutput</span> <span class="operator">=</span> <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'codeShellOutput_'</span><span class="operator">]</span><span class="text">
</span>                <span class="keyword">del</span> <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'codeShellOutput_'</span><span class="operator">]</span><span class="text">
</span>                <span class="keyword">del</span> <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'_print_'</span><span class="operator">]</span><span class="text">
</span>                <span class="comment"># These are apparently created by exec or something
</span>                <span class="keyword">del</span> <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'__builtins__'</span><span class="operator">]</span><span class="text">
</span>                <span class="keyword">del</span> <span class="name">restrictedScope</span><span class="operator">[</span><span class="string">'_print'</span><span class="operator">]</span><span class="text">
</span>        <span class="keyword">except</span> <span class="name">ImportError</span><span class="operator">:</span><span class="text">
</span>                <span class="name">codeOutput</span> <span class="operator">=</span> <span class="string">"ImportError.  Importing is disallowed"</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">return</span> <span class="operator">(</span><span class="name">codeOutput</span><span class="operator">,</span> <span class="name">restrictedScope</span><span class="operator">)</span><span class="text"></span>
</pre></body>
</html>
